from __future__ import annotations

from typing import Any, Mapping

DEFAULT_THEME_ID = "esprit"
SUPPORTED_THEME_IDS: tuple[str, ...] = ("esprit", "ember", "matrix", "glacier", "crt", "sakura", "highcontrast")

REQUIRED_SEMANTIC_KEYS: tuple[str, ...] = (
    "text",
    "muted",
    "accent",
    "info",
    "success",
    "warning",
    "error",
    "border",
    "status_running",
    "status_waiting",
    "status_completed",
    "status_failed",
    "status_idle",
)

MARKER_KEYS: tuple[str, ...] = (
    "run",
    "ok",
    "warn",
    "err",
    "bug",
    "todo",
    "web",
    "think",
)


_THEME_TOKENS: dict[str, dict[str, Any]] = {
    "esprit": {
        "text": "#e8d5d5",
        "muted": "#947575",
        "accent": "#22d3ee",
        "info": "#38bdf8",
        "success": "#22c55e",
        "warning": "#f59e0b",
        "error": "#ef4444",
        "border": "#2f0f0f",
        "status_running": "#22d3ee",
        "status_waiting": "#f59e0b",
        "status_completed": "#22c55e",
        "status_failed": "#ef4444",
        "status_idle": "#947575",
        "marker_run": "#22d3ee",
        "marker_ok": "#22c55e",
        "marker_warn": "#f59e0b",
        "marker_err": "#ef4444",
        "marker_bug": "#f97316",
        "marker_todo": "#a78bfa",
        "marker_web": "#38bdf8",
        "marker_think": "#14b8a6",
        "subagent_header": "#22d3ee",
        "vuln_badge": "#ef4444",
        "compacting_primary": "#f59e0b",
        "compacting_secondary": "#d97706",
        "keymap_key": "#f8f4f4",
        "keymap_text": "#947575",
        "verb_primary": "#e8d5d5",
        "verb_secondary": "#947575",
        "ghost_outline": "#38bdf8",
        "ghost_paren": "#22d3ee",
        "ghost_eyes": "#e8d5d5",
        "ghost_tail": "#22d3ee",
        "sweep_dot_color": "#0a3d1f",
        "sweep_colors": (
            "#000000",
            "#001014",
            "#03232d",
            "#0b3a47",
            "#0f5b6f",
            "#0f7993",
            "#22d3ee",
            "#67e8f9",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#1a0f00",
            "#3d2400",
            "#5c3a00",
            "#7a5200",
            "#a36e00",
            "#e09b00",
            "#f59e0b",
        ),
        "shimmer_colors": (
            "#3f3f46",
            "#52525b",
            "#71717a",
            "#a1a1aa",
            "#d4d4d8",
            "#f4f4f5",
            "#ffffff",
            "#f4f4f5",
            "#d4d4d8",
            "#a1a1aa",
            "#71717a",
            "#52525b",
            "#3f3f46",
        ),
    },
    "ember": {
        "text": "#f1d6bf",
        "muted": "#b18a6b",
        "accent": "#f97316",
        "info": "#fb923c",
        "success": "#65a30d",
        "warning": "#f59e0b",
        "error": "#dc2626",
        "border": "#4b2a16",
        "status_running": "#f97316",
        "status_waiting": "#f59e0b",
        "status_completed": "#65a30d",
        "status_failed": "#dc2626",
        "status_idle": "#b18a6b",
        "marker_run": "#f97316",
        "marker_ok": "#84cc16",
        "marker_warn": "#fbbf24",
        "marker_err": "#ef4444",
        "marker_bug": "#c2410c",
        "marker_todo": "#c084fc",
        "marker_web": "#fb923c",
        "marker_think": "#22d3ee",
        "subagent_header": "#f97316",
        "vuln_badge": "#dc2626",
        "compacting_primary": "#f59e0b",
        "compacting_secondary": "#d97706",
        "keymap_key": "#ffe8d6",
        "keymap_text": "#b18a6b",
        "verb_primary": "#f1d6bf",
        "verb_secondary": "#b18a6b",
        "ghost_outline": "#fb923c",
        "ghost_paren": "#f97316",
        "ghost_eyes": "#f1d6bf",
        "ghost_tail": "#f97316",
        "sweep_dot_color": "#2d1608",
        "sweep_colors": (
            "#000000",
            "#120b06",
            "#24140c",
            "#3a1f11",
            "#552a15",
            "#7a3a1c",
            "#b45309",
            "#f97316",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#171005",
            "#2d1c07",
            "#45300b",
            "#654510",
            "#8a5d13",
            "#c07c18",
            "#f59e0b",
        ),
        "shimmer_colors": (
            "#3b2a1f",
            "#4d3728",
            "#624734",
            "#7a5b43",
            "#9a7457",
            "#bb9171",
            "#e0b899",
            "#bb9171",
            "#9a7457",
            "#7a5b43",
            "#624734",
            "#4d3728",
            "#3b2a1f",
        ),
    },
    "matrix": {
        "text": "#cdeecf",
        "muted": "#7fb48b",
        "accent": "#22c55e",
        "info": "#4ade80",
        "success": "#22c55e",
        "warning": "#84cc16",
        "error": "#ef4444",
        "border": "#1f3d27",
        "status_running": "#22c55e",
        "status_waiting": "#84cc16",
        "status_completed": "#22c55e",
        "status_failed": "#ef4444",
        "status_idle": "#7fb48b",
        "marker_run": "#22c55e",
        "marker_ok": "#4ade80",
        "marker_warn": "#84cc16",
        "marker_err": "#ef4444",
        "marker_bug": "#f59e0b",
        "marker_todo": "#2dd4bf",
        "marker_web": "#38bdf8",
        "marker_think": "#a3e635",
        "subagent_header": "#22c55e",
        "vuln_badge": "#ef4444",
        "compacting_primary": "#84cc16",
        "compacting_secondary": "#65a30d",
        "keymap_key": "#e3ffe6",
        "keymap_text": "#7fb48b",
        "verb_primary": "#cdeecf",
        "verb_secondary": "#7fb48b",
        "ghost_outline": "#4ade80",
        "ghost_paren": "#22c55e",
        "ghost_eyes": "#cdeecf",
        "ghost_tail": "#22c55e",
        "sweep_dot_color": "#0a240a",
        "sweep_colors": (
            "#000000",
            "#031007",
            "#062014",
            "#0a2f1f",
            "#0f442d",
            "#13623f",
            "#22c55e",
            "#4ade80",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#0b1304",
            "#162709",
            "#223d0f",
            "#315714",
            "#4a7a1d",
            "#6da92c",
            "#84cc16",
        ),
        "shimmer_colors": (
            "#17321e",
            "#21452a",
            "#2e5d38",
            "#3b7547",
            "#4b9259",
            "#60ae6e",
            "#87d895",
            "#60ae6e",
            "#4b9259",
            "#3b7547",
            "#2e5d38",
            "#21452a",
            "#17321e",
        ),
    },
    "glacier": {
        "text": "#d9e7f3",
        "muted": "#9ab9d3",
        "accent": "#38bdf8",
        "info": "#7dd3fc",
        "success": "#34d399",
        "warning": "#fbbf24",
        "error": "#f87171",
        "border": "#1a344d",
        "status_running": "#38bdf8",
        "status_waiting": "#fbbf24",
        "status_completed": "#34d399",
        "status_failed": "#f87171",
        "status_idle": "#9ab9d3",
        "marker_run": "#38bdf8",
        "marker_ok": "#34d399",
        "marker_warn": "#fbbf24",
        "marker_err": "#f87171",
        "marker_bug": "#f97316",
        "marker_todo": "#a78bfa",
        "marker_web": "#7dd3fc",
        "marker_think": "#22d3ee",
        "subagent_header": "#38bdf8",
        "vuln_badge": "#f87171",
        "compacting_primary": "#fbbf24",
        "compacting_secondary": "#d97706",
        "keymap_key": "#f0f8ff",
        "keymap_text": "#9ab9d3",
        "verb_primary": "#d9e7f3",
        "verb_secondary": "#9ab9d3",
        "ghost_outline": "#7dd3fc",
        "ghost_paren": "#38bdf8",
        "ghost_eyes": "#d9e7f3",
        "ghost_tail": "#38bdf8",
        "sweep_dot_color": "#0b2032",
        "sweep_colors": (
            "#000000",
            "#041019",
            "#082133",
            "#0d3047",
            "#124560",
            "#1a6387",
            "#38bdf8",
            "#7dd3fc",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#181203",
            "#2f2508",
            "#48390c",
            "#665113",
            "#8a6d1a",
            "#c99525",
            "#fbbf24",
        ),
        "shimmer_colors": (
            "#1f2f3f",
            "#2a3f54",
            "#36506a",
            "#436484",
            "#567fa4",
            "#6d9fc6",
            "#97c8e8",
            "#6d9fc6",
            "#567fa4",
            "#436484",
            "#36506a",
            "#2a3f54",
            "#1f2f3f",
        ),
    },
    "crt": {
        "text": "#d7ffd7",
        "muted": "#7fd27f",
        "accent": "#33ff33",
        "info": "#66ff66",
        "success": "#66ff66",
        "warning": "#7ddb50",
        "error": "#ff5555",
        "border": "#1a801a",
        "status_running": "#33ff33",
        "status_waiting": "#7ddb50",
        "status_completed": "#66ff66",
        "status_failed": "#ff5555",
        "status_idle": "#7fd27f",
        "marker_run": "#33ff33",
        "marker_ok": "#66ff66",
        "marker_warn": "#7ddb50",
        "marker_err": "#ff5555",
        "marker_bug": "#ff8844",
        "marker_todo": "#99ffee",
        "marker_web": "#66ff99",
        "marker_think": "#ccff66",
        "subagent_header": "#33ff33",
        "vuln_badge": "#ff5555",
        "compacting_primary": "#66ff66",
        "compacting_secondary": "#2ecc2e",
        "keymap_key": "#e6ffe6",
        "keymap_text": "#7fd27f",
        "verb_primary": "#d7ffd7",
        "verb_secondary": "#7fd27f",
        "ghost_outline": "#99ff99",
        "ghost_paren": "#66ff66",
        "ghost_eyes": "#eaffea",
        "ghost_tail": "#33ff33",
        "sweep_dot_color": "#0a240a",
        "sweep_colors": (
            "#000000",
            "#061406",
            "#0a290a",
            "#0f3d0f",
            "#145214",
            "#1c7a1c",
            "#33cc33",
            "#66ff66",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#071807",
            "#0d2c0d",
            "#134013",
            "#1a5a1a",
            "#258525",
            "#33cc33",
            "#66ff66",
        ),
        "shimmer_colors": (
            "#123412",
            "#185218",
            "#1e711e",
            "#289328",
            "#37b337",
            "#52d052",
            "#87f587",
            "#52d052",
            "#37b337",
            "#289328",
            "#1e711e",
            "#185218",
            "#123412",
        ),
    },
    "sakura": {
        "text": "#f1c6dd",
        "muted": "#8f5f78",
        "accent": "#f472b6",
        "info": "#f9a8d4",
        "success": "#86efac",
        "warning": "#fcd34d",
        "error": "#fb7185",
        "border": "#9f1239",
        "status_running": "#f472b6",
        "status_waiting": "#f9a8d4",
        "status_completed": "#86efac",
        "status_failed": "#fb7185",
        "status_idle": "#8f5f78",
        "marker_run": "#f472b6",
        "marker_ok": "#86efac",
        "marker_warn": "#fcd34d",
        "marker_err": "#fb7185",
        "marker_bug": "#f97316",
        "marker_todo": "#e879f9",
        "marker_web": "#a78bfa",
        "marker_think": "#f9a8d4",
        "subagent_header": "#ec4899",
        "vuln_badge": "#fb7185",
        "compacting_primary": "#f9a8d4",
        "compacting_secondary": "#be185d",
        "keymap_key": "#fce7f3",
        "keymap_text": "#8f5f78",
        "verb_primary": "#f1c6dd",
        "verb_secondary": "#8f5f78",
        "ghost_outline": "#f472b6",
        "ghost_paren": "#ec4899",
        "ghost_eyes": "#fce7f3",
        "ghost_tail": "#be185d",
        "sweep_dot_color": "#2a0f1f",
        "sweep_colors": (
            "#000000",
            "#1a0611",
            "#330c22",
            "#4d1233",
            "#801f55",
            "#b32e77",
            "#e64d9e",
            "#f472b6",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#1a0611",
            "#330c22",
            "#4d1233",
            "#801f55",
            "#b32e77",
            "#e64d9e",
            "#f472b6",
        ),
        "shimmer_colors": (
            "#3d1029",
            "#5c1840",
            "#7a2057",
            "#99286e",
            "#b83086",
            "#d63a9e",
            "#f472b6",
            "#d63a9e",
            "#b83086",
            "#99286e",
            "#7a2057",
            "#5c1840",
            "#3d1029",
        ),
    },
    "highcontrast": {
        "text": "#FFFFFF",
        "muted": "#BBBBBB",
        "accent": "#00FFFF",
        "info": "#00BFFF",
        "success": "#00FF00",
        "warning": "#FFFF00",
        "error": "#FF0000",
        "border": "#FFFFFF",
        "status_running": "#00FFFF",
        "status_waiting": "#FFFF00",
        "status_completed": "#00FF00",
        "status_failed": "#FF0000",
        "status_idle": "#BBBBBB",
        "marker_run": "#00FFFF",
        "marker_ok": "#00FF00",
        "marker_warn": "#FFFF00",
        "marker_err": "#FF0000",
        "marker_bug": "#FF6600",
        "marker_todo": "#FF00FF",
        "marker_web": "#00BFFF",
        "marker_think": "#00FFCC",
        "subagent_header": "#00FFFF",
        "vuln_badge": "#FF0000",
        "compacting_primary": "#FFFF00",
        "compacting_secondary": "#CCCC00",
        "keymap_key": "#FFFFFF",
        "keymap_text": "#BBBBBB",
        "verb_primary": "#FFFFFF",
        "verb_secondary": "#BBBBBB",
        "ghost_outline": "#00BFFF",
        "ghost_paren": "#00FFFF",
        "ghost_eyes": "#FFFFFF",
        "ghost_tail": "#00FFFF",
        "sweep_dot_color": "#333333",
        "sweep_colors": (
            "#000000",
            "#001114",
            "#002228",
            "#00333D",
            "#004D5C",
            "#007080",
            "#00AAAA",
            "#00FFFF",
        ),
        "compact_sweep_colors": (
            "#000000",
            "#141400",
            "#282800",
            "#3D3D00",
            "#5C5C00",
            "#808000",
            "#BBBB00",
            "#FFFF00",
        ),
        "shimmer_colors": (
            "#333333",
            "#4D4D4D",
            "#666666",
            "#808080",
            "#999999",
            "#B3B3B3",
            "#FFFFFF",
            "#B3B3B3",
            "#999999",
            "#808080",
            "#666666",
            "#4D4D4D",
            "#333333",
        ),
    },
}


def normalize_theme_id(theme_id: str | None) -> str:
    if isinstance(theme_id, str) and theme_id in SUPPORTED_THEME_IDS:
        return theme_id
    return DEFAULT_THEME_ID


def get_theme_tokens(theme_id: str | None = None) -> dict[str, Any]:
    normalized_theme_id = normalize_theme_id(theme_id)
    return dict(_THEME_TOKENS[normalized_theme_id])


def get_theme_tokens_from_tool_data(
    tool_data: Mapping[str, Any], fallback_theme_id: str | None = None
) -> dict[str, Any]:
    raw_tokens = tool_data.get("_theme_tokens")
    if isinstance(raw_tokens, dict):
        return dict(raw_tokens)
    theme_id = tool_data.get("_theme_id") or fallback_theme_id
    return get_theme_tokens(str(theme_id) if theme_id is not None else None)


def get_marker_color(theme_tokens: Mapping[str, Any], marker: str) -> str:
    marker_id = marker.strip().lower().strip("[]")
    token_key = f"marker_{marker_id}"
    configured = theme_tokens.get(token_key)
    if isinstance(configured, str) and configured:
        return configured

    role_fallback: dict[str, str] = {
        "run": "status_running",
        "ok": "status_completed",
        "warn": "warning",
        "err": "status_failed",
        "bug": "error",
        "todo": "accent",
        "web": "info",
        "think": "accent",
    }
    role_key = role_fallback.get(marker_id, "accent")
    role_color = theme_tokens.get(role_key)
    if isinstance(role_color, str) and role_color:
        return role_color
    return str(theme_tokens.get("accent", "#22d3ee"))
